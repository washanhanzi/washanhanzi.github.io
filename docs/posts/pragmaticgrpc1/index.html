<!DOCTYPE html><html lang="en-us" q:render="static-ssr" q:container="paused" q:version="1.2.6" q:base="/build/" q:locale q:manifest-hash="3d4jae"><!--qv q:id=0 q:key=3scc:pY_0--><!--qv q:id=1 q:key=TxCF:35_3--><!--qv q:s q:sref=1 q:key=--><head q:head><meta charSet="utf-8" q:head><title q:head>N1ll</title><link href="/manifest.json" rel="manifest" q:head><meta content="width=device-width, initial-scale=1.0" name="viewport" q:head><meta content="A personal blog about programming and writing" name="description" q:head><!--qv q:key=35_0--><script q:key="0b_0" q:head>!(function(w,p,f,c){if(!window.crossOriginIsolated && !navigator.serviceWorker) return;c=w[p]=Object.assign(w[p]||{},{"lib":"/partytown/"});c[f]=(c[f]||[]).concat(["dataLayer.push"])})(window,'partytown','forward');/* Partytown 0.8.2 - MIT builder.io */
!function(t,e,n,i,o,r,a,s,d,c,l,p){function u(){p||(p=1,"/"==(a=(r.lib||"/~partytown/")+(r.debug?"debug/":""))[0]&&(d=e.querySelectorAll('script[type="text/partytown"]'),i!=t?i.dispatchEvent(new CustomEvent("pt1",{detail:t})):(s=setTimeout(f,1e4),e.addEventListener("pt0",w),o?h(1):n.serviceWorker?n.serviceWorker.register(a+(r.swPath||"partytown-sw.js"),{scope:a}).then((function(t){t.active?h():t.installing&&t.installing.addEventListener("statechange",(function(t){"activated"==t.target.state&&h()}))}),console.error):f())))}function h(t){c=e.createElement(t?"script":"iframe"),t||(c.style.display="block",c.style.width="0",c.style.height="0",c.style.border="0",c.style.visibility="hidden",c.setAttribute("aria-hidden",!0)),c.src=a+"partytown-"+(t?"atomics.js?v=0.8.2":"sandbox-sw.html?"+Date.now()),e.querySelector(r.sandboxParent||"body").appendChild(c)}function f(n,o){for(w(),i==t&&(r.forward||[]).map((function(e){delete t[e.split(".")[0]]})),n=0;n<d.length;n++)(o=e.createElement("script")).innerHTML=d[n].innerHTML,o.nonce=r.nonce,e.head.appendChild(o);c&&c.parentNode.removeChild(c)}function w(){clearTimeout(s)}r=t.partytown||{},i==t&&(r.forward||[]).map((function(e){l=t,e.split(".").map((function(e,n,i){l=l[i[n]]=n+1<i.length?"push"==i[n+1]?[]:l[i[n]]||{}:function(){(t._ptf=t._ptf||[]).push(i,arguments)}}))})),"complete"==e.readyState?u():(t.addEventListener("DOMContentLoaded",u),t.addEventListener("load",u))}(window,document,navigator,top,window.crossOriginIsolated);</script><!--/qv--><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-FSZE01YQC3" type="text/partytown" q:head></script><link rel="stylesheet" href="/build/q-bac85e75.css"><style q:style="lcydw1-0" hidden>:root{view-transition-name:none}</style></head><body lang="en"><!--qv q:id=2 q:key=e0ss:35_1--><!--qv q:key=zl_1--><!--qv q:id=3 q:key=VkLN:zl_0--><div class="grid grid-cols-1 gap-4 px-10 mt-7 w-full md:max-w-5xl md:mx-auto dark" q:key="XF_1"><main><!--qv q:s q:sref=3 q:key=--><!--qv q:id=4 q:key=nO36:zl_0--><style q:style="pe5i3o-0" hidden>pre{border:1px solid tomato}
</style><style q:style="cbenux-1" hidden>code[class*=language-],pre[class*=language-]{color:#abb2bf;text-shadow:0 1px rgba(0,0,0,.3);font-family:Fira Code,Fira Mono,Menlo,Consolas,DejaVu Sans Mono,monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] *::-moz-selection,pre[class*=language-] *::-moz-selection{background:hsl(220,13%,28%);color:inherit;text-shadow:none}code[class*=language-]::selection,code[class*=language-] *::selection,pre[class*=language-] *::selection{background:hsl(220,13%,28%);color:inherit;text-shadow:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-]{padding:.2em .3em;border-radius:.3em;white-space:normal}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}.token.comment,.token.prolog,.token.cdata{color:#5c6370}.token.doctype,.token.punctuation,.token.entity{color:#abb2bf}.token.attr-name,.token.class-name,.token.boolean,.token.constant,.token.number,.token.atrule{color:#d19a66}.token.keyword{color:#c678dd}.token.property,.token.tag,.token.symbol,.token.deleted,.token.important{color:#e06c75}.token.selector,.token.string,.token.char,.token.builtin,.token.inserted,.token.regex,.token.attr-value,.token.attr-value>.token.punctuation{color:#98c379}.token.variable,.token.operator,.token.function{color:#61afef}.token.url{color:#56b6c2}.token.attr-value>.token.punctuation.attr-equals,.token.special-attr>.token.attr-value>.token.value.css{color:#abb2bf}.language-css .token.selector{color:#e06c75}.language-css .token.property{color:#abb2bf}.language-css .token.function,.language-css .token.url>.token.function{color:#56b6c2}.language-css .token.url>.token.string.url{color:#98c379}.language-css .token.important,.language-css .token.atrule .token.rule,.language-javascript .token.operator{color:#c678dd}.language-javascript .token.template-string>.token.interpolation>.token.interpolation-punctuation.punctuation{color:#be5046}.language-json .token.operator{color:#abb2bf}.language-json .token.null.keyword{color:#d19a66}.language-markdown .token.url,.language-markdown .token.url>.token.operator,.language-markdown .token.url-reference.url>.token.string{color:#abb2bf}.language-markdown .token.url>.token.content{color:#61afef}.language-markdown .token.url>.token.url,.language-markdown .token.url-reference.url{color:#56b6c2}.language-markdown .token.blockquote.punctuation,.language-markdown .token.hr.punctuation{color:#5c6370;font-style:italic}.language-markdown .token.code-snippet{color:#98c379}.language-markdown .token.bold .token.content{color:#d19a66}.language-markdown .token.italic .token.content{color:#c678dd}.language-markdown .token.strike .token.content,.language-markdown .token.strike .token.punctuation,.language-markdown .token.list.punctuation,.language-markdown .token.title.important>.token.punctuation{color:#e06c75}.token.bold{font-weight:700}.token.comment{color:#0ffc03}.token.comment,.token.italic{font-style:italic}.token.entity{cursor:help}.token.namespace{opacity:.8}.token.token.tab:not(:empty):before,.token.token.cr:before,.token.token.lf:before,.token.token.space:before{color:#abb2bf26;text-shadow:none}div.code-toolbar>.toolbar.toolbar>.toolbar-item{margin-right:.4em}div.code-toolbar>.toolbar.toolbar>.toolbar-item>button,div.code-toolbar>.toolbar.toolbar>.toolbar-item>a,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span{background:hsl(220,13%,26%);color:#828997;padding:.1em .4em;border-radius:.3em}div.code-toolbar>.toolbar.toolbar>.toolbar-item>button:hover,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>a:hover,div.code-toolbar>.toolbar.toolbar>.toolbar-item>a:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span:hover,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span:focus{background:hsl(220,13%,28%);color:#abb2bf}.line-highlight.line-highlight{background:hsla(220,100%,80%,.04)}.line-highlight.line-highlight:before,.line-highlight.line-highlight[data-end]:after{background:hsl(220,13%,26%);color:#abb2bf;padding:.1em .6em;border-radius:.3em;box-shadow:0 2px #0003}pre[id].linkable-line-numbers.linkable-line-numbers span.line-numbers-rows>span:hover:before{background-color:#99bbff0a}.line-numbers.line-numbers .line-numbers-rows,.command-line .command-line-prompt{border-right-color:#abb2bf26}.line-numbers .line-numbers-rows>span:before,.command-line .command-line-prompt>span:before{color:#636d83}.rainbow-braces .token.token.punctuation.brace-level-1,.rainbow-braces .token.token.punctuation.brace-level-5,.rainbow-braces .token.token.punctuation.brace-level-9{color:#e06c75}.rainbow-braces .token.token.punctuation.brace-level-2,.rainbow-braces .token.token.punctuation.brace-level-6,.rainbow-braces .token.token.punctuation.brace-level-10{color:#98c379}.rainbow-braces .token.token.punctuation.brace-level-3,.rainbow-braces .token.token.punctuation.brace-level-7,.rainbow-braces .token.token.punctuation.brace-level-11{color:#61afef}.rainbow-braces .token.token.punctuation.brace-level-4,.rainbow-braces .token.token.punctuation.brace-level-8,.rainbow-braces .token.token.punctuation.brace-level-12{color:#c678dd}pre.diff-highlight>code .token.token.deleted:not(.prefix),pre>code.diff-highlight .token.token.deleted:not(.prefix){background-color:#ff526626}pre.diff-highlight>code .token.token.deleted:not(.prefix)::-moz-selection,pre.diff-highlight>code .token.token.deleted:not(.prefix) *::-moz-selection,pre>code.diff-highlight .token.token.deleted:not(.prefix)::-moz-selection,pre>code.diff-highlight .token.token.deleted:not(.prefix) *::-moz-selection{background-color:#fb566940}pre.diff-highlight>code .token.token.deleted:not(.prefix)::selection,pre.diff-highlight>code .token.token.deleted:not(.prefix) *::selection,pre>code.diff-highlight .token.token.deleted:not(.prefix)::selection,pre>code.diff-highlight .token.token.deleted:not(.prefix) *::selection{background-color:#fb566940}pre.diff-highlight>code .token.token.inserted:not(.prefix),pre>code.diff-highlight .token.token.inserted:not(.prefix){background-color:#1aff5b26}pre.diff-highlight>code .token.token.inserted:not(.prefix)::-moz-selection,pre.diff-highlight>code .token.token.inserted:not(.prefix) *::-moz-selection,pre>code.diff-highlight .token.token.inserted:not(.prefix)::-moz-selection,pre>code.diff-highlight .token.token.inserted:not(.prefix) *::-moz-selection{background-color:#38e06240}pre.diff-highlight>code .token.token.inserted:not(.prefix)::selection,pre.diff-highlight>code .token.token.inserted:not(.prefix) *::selection,pre>code.diff-highlight .token.token.inserted:not(.prefix)::selection,pre>code.diff-highlight .token.token.inserted:not(.prefix) *::selection{background-color:#38e06240}.prism-previewer.prism-previewer:before,.prism-previewer-gradient.prism-previewer-gradient div{border-color:#262931}.prism-previewer-color.prism-previewer-color:before,.prism-previewer-gradient.prism-previewer-gradient div,.prism-previewer-easing.prism-previewer-easing:before{border-radius:.3em}.prism-previewer.prism-previewer:after{border-top-color:#262931}.prism-previewer-flipped.prism-previewer-flipped.after{border-bottom-color:#262931}.prism-previewer-angle.prism-previewer-angle:before,.prism-previewer-time.prism-previewer-time:before,.prism-previewer-easing.prism-previewer-easing{background:hsl(219,13%,22%)}.prism-previewer-angle.prism-previewer-angle circle,.prism-previewer-time.prism-previewer-time circle{stroke:#abb2bf;stroke-opacity:1}.prism-previewer-easing.prism-previewer-easing circle,.prism-previewer-easing.prism-previewer-easing path,.prism-previewer-easing.prism-previewer-easing line{stroke:#abb2bf}.prism-previewer-easing.prism-previewer-easing circle{fill:transparent}
</style><style q:style="ikgwqs-2" hidden>pre{overflow-x:scroll}.code-highlight{float:left;min-width:100%}.code-line{display:block;padding-left:16px;padding-right:16px;margin-left:-16px;margin-right:-16px;border-left:4px solid rgba(0,0,0,0)}.code-line.inserted{background-color:#10b98133}.code-line.deleted{background-color:#ef444433}.highlight-line{margin-left:-16px;margin-right:-16px;background-color:#37415180;border-left:4px solid rgb(59,130,246)}.line-number:before{display:inline-block;width:1rem;text-align:right;margin-right:16px;margin-left:-8px;color:#9ca3af;content:attr(line)}
</style><div class="grid grid-cols-1 md:grid-cols-[1fr_800px_1.2fr] gap-4" q:key="p5_1"><div></div><article class="prose prose-base dark:prose-invert p-4 overflow-x-hidden ::selection:bg-fuchsia-700"><!--qv q:s q:sref=4 q:key=--><!--qv q:key=-iLxVf+i--><h1 id="pragmatic-grpc-1"><a aria-hidden="true" tabindex="-1" href="#pragmatic-grpc-1"><span class="icon icon-link"></span></a>Pragmatic gRPC 1</h1>
<blockquote>
<p>This artical is based on proto3 and go</p>
</blockquote>
<h2 id="proto-file"><a aria-hidden="true" tabindex="-1" href="#proto-file"><span class="icon icon-link"></span></a><code>proto</code> file</h2>
<p>To really start to build a gRPC service, it's good to check some rules for the <code>proto</code> file.</p>
<ul>
<li>
<p>The <code>package</code> field should contain version information, like <code>HelloService.v1</code></p>
</li>
<li>
<p>The request and response message should name with a certain rule, generally it will be the service RPC method name with a <code>Request</code> or <code>Response</code> suffix.</p>
<p>Like:</p>
</li>
</ul>
<pre class="language-protobuf"><code class="language-protobuf code-highlight"><span class="code-line"><span class="token keyword">rpc</span> <span class="token function">HelloWorld</span><span class="token punctuation">(</span><span class="token class-name">HelloWorldRequest</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token class-name">HelloWorldResponse</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</span></code></pre>
<p>A good reference is
<a href="https://cloud.google.com/apis/design">Goole API design guide</a>.</p>
<p>Just keep in mind, protocol buffer, like <code>go</code>, always have a default value, it can't differentiate an unset value from a default value. As an example, always keep <code>0</code> as the unknown or unset value for <code>enum</code> (you should do it in <code>go</code> either, always start
from <code>iota+1</code>):</p>
<pre class="language-protobuf"><code class="language-protobuf code-highlight"><span class="code-line"><span class="token keyword">enum</span> <span class="token class-name">Hello</span> <span class="token punctuation">{</span>Â 
</span><span class="code-line">	UNKNOWN <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</span><span class="code-line">	STARTED <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</span><span class="code-line">	RUNNING <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<h3 id="struct-first-or-proto-first"><a aria-hidden="true" tabindex="-1" href="#struct-first-or-proto-first"><span class="icon icon-link"></span></a>Struct first or Proto first?</h3>
<p>To start building your gRPC service, you can either choose to first define the <code>proto</code> file or the <code>go</code> struct. Let's consider these two approaches.</p>
<ol>
<li>Struct first</li>
</ol>
<p>Some packages will generate <code>proto</code> definition from your <code>struct</code> type, but I didn't try them out. The benefit of this approach is appealing, especially if you use an ORM like <code>gorm</code>. The <code>struct</code> will generate all the things you need, and it becomes your only source of truth.</p>
<p>I think this approach is poorly <a href="https://stackoverflow.com/questions/57064482/how-to-cast-convert-a-struct-to-protobuf">supported</a>.</p>
<p>Generally, I preper write <code>proto</code> file first, it's really easy to use <code>proto</code> file to work with the front end or other teams to finalize the API.</p>
<ol start="2">
<li>Proto first</li>
</ol>
<p>With all the code generated from your <code>proto</code> file, there is a tendency to think <code>proto</code> file as your source of truth. Don't. The <code>proto</code> file mostly belongs to the <code>controller</code>, it shouldn't couple with your business logic or database interactions.</p>
<p>Another problem is you can't easily cast your <code>struct</code> type to <code>proto</code> generated <code>struct</code> type (the <code>proto.Message</code> type). The generated type has some additional fields. An easy solution is to use the <code>gogofaster</code> binary of
<a href="https://github.com/gogo/protobuf">gogoprotobuf</a>, like:</p>
<pre class="language-protobuf"><code class="language-protobuf code-highlight"><span class="code-line">protoc <span class="token operator">--</span>proto_path proto  <span class="token operator">--</span>gogofaster_out<span class="token operator">=</span><span class="token string">"plugins=grpc:."</span> <span class="token punctuation">.</span><span class="token operator">/</span>proto<span class="token comment">/*.proto
</span></span></code></pre>
<p>This package provides lots of extensions to customize the <code>[golang/protobuf](https://github.com/golang/protobuf)</code>. Like the support of go data type and marshaller function.</p>
<p>The problem is the helpful library is <a href="https://github.com/gogo/protobuf/issues/691">looking for new ownership</a>, and it
didn't support the newer version of go protocol buffer API.</p>
<p>Go has two versions of protocol buffer library, <a href="https://pkg.go.dev/github.com/golang/protobuf">v1</a> and <a href="https://pkg.go.dev/google.golang.org/protobuf">v2</a>. The newer version has many improvements like the <a href="https://blog.golang.org/protobuf-apiv2">reflection api</a>.</p>
<p>If you want to start a new project with gRPC, I highly suggest you start with v2 API. Then
you have 2 choices to cast your <code>struct</code> type to the <code>proto</code> generated type.</p>
<ol>
<li>Serillize and desrillize. Make sure you use the right library:
<code>google.golang.org/protobuf/encoding/protojson</code>.</li>
<li>Write some boilerplate code on your own.</li>
</ol>
<p>I think the only thing to consider is performance, just benchmark with your proto message you will conclude. Generally, I prefer the second one.</p>
<h3 id="code-generation"><a aria-hidden="true" tabindex="-1" href="#code-generation"><span class="icon icon-link"></span></a>code generation</h3>
<p>With the new v2 API, here is an example to generate go code from <code>proto</code> file.</p>
<pre class="language-shell"><code class="language-shell code-highlight"><span class="code-line">protoc <span class="token parameter variable">-I</span><span class="token operator">=</span>proto --go<span class="token punctuation">\</span>_out<span class="token punctuation">\</span><span class="token operator">=</span>module<span class="token punctuation">\</span><span class="token operator">=</span>github.com/hello/hello:. <span class="token punctuation">\</span>
</span><span class="code-line">--go-grpc_out<span class="token operator">=</span>module<span class="token operator">=</span>github.com/hello/hello:. <span class="token punctuation">\</span>
</span><span class="code-line">./proto/<span class="token punctuation">\</span>*.proto
</span></code></pre>
<p>In every <code>proto</code> file, add a line to specify the <a href="https://github.com/protocolbuffers/protobuf-go/releases#v1.21-generator">go module</a>:</p>
<pre class="language-protobuf"><code class="language-protobuf code-highlight"><span class="code-line"><span class="token keyword">option</span> go_package <span class="token operator">=</span> <span class="token string">"github.com/hello/hello/yourModule/pb"</span><span class="token punctuation">;</span>
</span></code></pre>
<p>And the generated code will be put into the <code>pb</code> folder under every specific
module.</p>
<h2 id="error-handling"><a aria-hidden="true" tabindex="-1" href="#error-handling"><span class="icon icon-link"></span></a>Error handling</h2>
<p>In the <code>restful</code> API, sometimes people put an error code and error message in every response (which is a bad practice). An example with <code>proto</code> will be:</p>
<pre class="language-protobuf"><code class="language-protobuf code-highlight"><span class="code-line"><span class="token keyword">message</span> <span class="token class-name">Response</span> <span class="token punctuation">{</span>
</span><span class="code-line">	<span class="token builtin">string</span> data <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</span><span class="code-line">	<span class="token builtin">int32</span> code <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
</span><span class="code-line">	<span class="token builtin">string</span> error_msg <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<p>Don't do this in gRPC. gRPC error already contains the error code and the error message. If you got a response with code <code>ok</code>, then it indicates the request is <code>successful(?)</code>. To construct a gRPC error is simple:</p>
<pre class="language-go"><code class="language-go code-highlight"><span class="code-line">status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> <span class="token string">"request failed"</span><span class="token punctuation">)</span>
</span></code></pre>
<p>You can check the gRPC error type with:</p>
<pre class="language-go"><code class="language-go code-highlight"><span class="code-line"><span class="token comment">//"google.golang.org/grpc/status"</span>
</span><span class="code-line"><span class="token keyword">if</span> se<span class="token punctuation">,</span> ok <span class="token operator">:=</span> status<span class="token punctuation">.</span><span class="token function">FromError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>ok <span class="token punctuation">{</span>
</span><span class="code-line">	<span class="token keyword">return</span> se<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<p>You can read more about the gRPC error code and explanation <a href="https://pkg.go.dev/google.golang.org/grpc/codes">here</a>.</p>
<p>For all the error codes, your application should only consider returning these:</p>
<ul>
<li>InvalidArgument <a href="https://pkg.go.dev/google.golang.org/grpc/codes#Code">Code</a> = 3</li>
<li>NotFound <a href="https://pkg.go.dev/google.golang.org/grpc/codes#Code">Code</a> = 5</li>
<li>AlreadyExists <a href="https://pkg.go.dev/google.golang.org/grpc/codes#Code">Code</a> = 6</li>
<li>PermissionDenied <a href="https://pkg.go.dev/google.golang.org/grpc/codes#Code">Code</a> = 7</li>
<li>FailedPrecondition <a href="https://pkg.go.dev/google.golang.org/grpc/codes#Code">Code</a> = 9</li>
<li>Aborted <a href="https://pkg.go.dev/google.golang.org/grpc/codes#Code">Code</a> = 10</li>
<li>OutOfRange <a href="https://pkg.go.dev/google.golang.org/grpc/codes#Code">Code</a> = 11</li>
<li>DataLoss <a href="https://pkg.go.dev/google.golang.org/grpc/codes#Code">Code</a> = 15</li>
<li>Unauthenticated <a href="https://pkg.go.dev/google.golang.org/grpc/codes#Code">Code</a> = 16</li>
</ul>
<p>If you want to dig more into the gRPC error, I suggest you to watch this
<a href="https://www.youtube.com/watch?v=g44zR3cyC-I&amp;t=512s">vedio</a>.</p>
<h2 id="deadline"><a aria-hidden="true" tabindex="-1" href="#deadline"><span class="icon icon-link"></span></a>Deadline</h2>
<p>It's best practice to use deadlines.</p>
<p>You can check whether the client set a deadline with:</p>
<pre class="language-go"><code class="language-go code-highlight"><span class="code-line">d<span class="token punctuation">,</span>ok <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Deadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
</span><span class="code-line">	<span class="token comment">//return some error</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">timeout <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment">//check timeout range</span>
</span><span class="code-line"><span class="token keyword">if</span> timeout <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second <span class="token operator">||</span> timeout <span class="token operator">&gt;</span> <span class="token number">30</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second <span class="token punctuation">{</span>
</span><span class="code-line">	<span class="token comment">//return some error</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<p>But, for all the gRPC and <code>gRPC-web</code> libraries among all the languages, I don't think every one of them will let you set deadlines in the client request. Just think twice to implement this check on your service.</p>
<p>You can check for more about deadline propagation in this
<a href="https://www.youtube.com/watch?v=Z_yD7YPL2oE&amp;list=FL_F0hJOcLaFNDptQDkcoSQA&amp;index=3">vedio</a>
(and other best practices).</p>
<h2 id="interceptor-and-metadata"><a aria-hidden="true" tabindex="-1" href="#interceptor-and-metadata"><span class="icon icon-link"></span></a>Interceptor and Metadata</h2>
<p>Interceptor is like the <code>middleware</code> in <code>REST</code> framework. You can get all your need from <a href="https://github.com/grpc-ecosystem/go-grpc-middleware">go-grpc-middleware</a>. The interceptor chain just works like a middleware chain in <code>REST</code> framework.</p>
<p>Almost in every <code>REST</code> framework, you can define a specific middleware for a specific controller or endpoint. Unfortunately, I haven't found an easy way to do this in <code>gRPC</code>, you can only write interceptor for the whole server, after that, you can filter your routes in the interceptor, or you can put the code directly in the <code>controller</code>.</p>
<p><code>middleware</code> chain uses metadata to pass data. Metadata in gRPC is the HTTP/2 version of HTTP headers. You can find a detailed explanation
<a href="https://github.com/grpc/grpc-go/blob/master/Documentation/grpc-metadata.md">here</a>.</p>
<p>A lot of things can be done with interceptors using metadata and context, like
authentication and authorization.</p>
<p>To read data from metadata is easy:</p>
<pre class="language-go"><code class="language-go code-highlight"><span class="code-line">md<span class="token punctuation">,</span> ok <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">FromIncomingContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token comment">//return some error</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<p><code>md</code> is of type <code>metadata.MD</code> which is <code>map[string][]string</code>. For example, to
get the trace id:</p>
<pre class="language-go"><code class="language-go code-highlight"><span class="code-line">ids<span class="token punctuation">,</span> ok <span class="token operator">:=</span> md<span class="token punctuation">[</span><span class="token string">"x-b3-traceid"</span><span class="token punctuation">]</span>
</span></code></pre>
<p>This solved part of our problem, to read data from requests. If you want to pass
some data to other interceptor or <code>controller</code>, you can use <code>context</code>.</p>
<pre class="language-go"><code class="language-go code-highlight"><span class="code-line"><span class="token keyword">type</span> key <span class="token builtin">int</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">//payloadKey is unexported, to prevent collisions with keys defined in other packages</span>
</span><span class="code-line"><span class="token keyword">var</span> payloadKey key
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">//Payload is a custom struct contain the data you want to pass on</span>
</span><span class="code-line"><span class="token keyword">type</span> Payload <span class="token keyword">struct</span> <span class="token punctuation">{</span>
</span><span class="code-line">    ID <span class="token builtin">string</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<p>First, we need an unexported type <code>payloadKey</code> as an unique identifier, which
won't be overwriten by other code or packages like an ordinary metadata name.</p>
<pre class="language-go"><code class="language-go code-highlight"><span class="code-line"><span class="token comment">//newContext will create a new go `context` with the payload</span>
</span><span class="code-line"><span class="token keyword">func</span> <span class="token function">newContext</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> payload <span class="token operator">*</span>Payload<span class="token punctuation">)</span> context<span class="token punctuation">.</span>Context <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token keyword">return</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> payloadKey<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<pre class="language-go"><code class="language-go code-highlight"><span class="code-line"><span class="token comment">//FromContext can be used in all controllers to get the payload from `context`</span>
</span><span class="code-line"><span class="token keyword">func</span> <span class="token function">FromContext</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Payload<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">	payload<span class="token punctuation">,</span> ok <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span>payloadKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>MetaPayload<span class="token punctuation">)</span>
</span><span class="code-line">	<span class="token keyword">return</span> payload<span class="token punctuation">,</span> ok
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<p>Combine with the above <code>interceptor chain</code>:</p>
<pre class="language-go"><code class="language-go code-highlight"><span class="code-line"><span class="token keyword">func</span> <span class="token function">UnaryInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> grpc<span class="token punctuation">.</span>UnaryServerInterceptor <span class="token punctuation">{</span>
</span><span class="code-line"> 	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> info <span class="token operator">*</span>grpc<span class="token punctuation">.</span>UnaryServerInfo<span class="token punctuation">,</span> handler grpc<span class="token punctuation">.</span>UnaryHandler<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">	<span class="token comment">//read data from metadata</span>
</span><span class="code-line">	<span class="token operator">...</span>
</span><span class="code-line">	<span class="token comment">//construct your payload</span>
</span><span class="code-line">	<span class="token operator">...</span>
</span><span class="code-line">	<span class="token comment">//return the new `context`</span>
</span><span class="code-line">	<span class="token keyword">return</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token function">newContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>req<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<p>That's only the case for unary interceptors, for stream interceptors, we can still use the unexported<code>payloadKey</code>and<code>FromContext</code>, but we need a wrapped stream.</p>
<pre class="language-go"><code class="language-go code-highlight"><span class="code-line"><span class="token comment">//WrappedStream implement the grpc stream interface, but we need to modify</span>
</span><span class="code-line"><span class="token comment">// the Context() method to return our new context with payload</span>
</span><span class="code-line"><span class="token keyword">type</span> WrappedStream <span class="token keyword">interface</span> <span class="token punctuation">{</span>
</span><span class="code-line">	grpc<span class="token punctuation">.</span>ServerStream
</span><span class="code-line">	<span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span>Context
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">type</span> wrappedStream <span class="token keyword">struct</span> <span class="token punctuation">{</span>
</span><span class="code-line">	grpc<span class="token punctuation">.</span>ServerStream
</span><span class="code-line">	parentCtx context<span class="token punctuation">.</span>Context
</span><span class="code-line">	payload   <span class="token operator">*</span>Payload
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">func</span> <span class="token function">newWrappedStream</span><span class="token punctuation">(</span>ss grpc<span class="token punctuation">.</span>ServerStream<span class="token punctuation">,</span> payload <span class="token operator">*</span>Payload<span class="token punctuation">)</span> <span class="token operator">*</span>wrappedStream <span class="token punctuation">{</span>
</span><span class="code-line"> 	<span class="token keyword">return</span> <span class="token operator">&amp;</span>wrappedStream<span class="token punctuation">{</span>ss<span class="token punctuation">,</span> ss<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> payload<span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">//Context() will return our context with payload</span>
</span><span class="code-line"><span class="token keyword">func</span> <span class="token punctuation">(</span>w <span class="token operator">*</span>wrappedStream<span class="token punctuation">)</span> <span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span>Context <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token keyword">return</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>w<span class="token punctuation">.</span>parentCtx<span class="token punctuation">,</span> payloadKey<span class="token punctuation">,</span> w<span class="token punctuation">.</span>payload<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<p>In this way, we utilize go's composition power, you don't need to modify any
existing code.</p>
<pre class="language-go"><code class="language-go code-highlight"><span class="code-line"><span class="token keyword">func</span> <span class="token function">StreamInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> grpc<span class="token punctuation">.</span>StreamServerInterceptor <span class="token punctuation">{</span>
</span><span class="code-line">	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>srv <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> ss grpc<span class="token punctuation">.</span>ServerStream<span class="token punctuation">,</span> info <span class="token operator">*</span>grpc<span class="token punctuation">.</span>StreamServerInfo<span class="token punctuation">,</span> handler grpc<span class="token punctuation">.</span>StreamHandler<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
</span><span class="code-line">	<span class="token comment">//some code</span>
</span><span class="code-line">	<span class="token operator">...</span>
</span><span class="code-line">	<span class="token keyword">return</span> <span class="token function">handler</span><span class="token punctuation">(</span>srv<span class="token punctuation">,</span><span class="token function">newWrappedStream</span><span class="token punctuation">(</span>ss<span class="token punctuation">,</span> <span class="token operator">&amp;</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<p>With all the above, you can easily implement your authentication and authorization logic.</p>
<p>But there is a problem, in <code>REST</code>, the request headers, URL and method generally contain all the information you need for authorization: the <code>authorization</code> header will contain information about the user identity, and the URL will tell you which resource the user requested, and the method is the user action. In gRPC, you still get the <code>authorization</code> metadata, you can get user action from:</p>
<pre class="language-go"><code class="language-go code-highlight"><span class="code-line"><span class="token comment">//The FullMethod will return a string contain gRPC package, service, rpc method</span>
</span><span class="code-line"><span class="token comment">//Remember the gRPC package is versioned? make sure update the gRPC package version won't break your authorization code</span>
</span><span class="code-line">info<span class="token punctuation">.</span>FullMethod
</span></code></pre>
<p>But you will not have any information about what resources the user requested. Then, you need to put that information in the metadata if you want to do authorization in the interceptor. Or you will put the requested resources in the request message.</p>
<p>I prefer the first approach, but carefully design your API, as data related to
your business logic is now in metadata and request message.</p>
<h2 id="partial-update"><a aria-hidden="true" tabindex="-1" href="#partial-update"><span class="icon icon-link"></span></a>Partial Update</h2>
<p>gRPC uses a <code>google.protobuf.FieldMask</code> to describe
<a href="https://cloud.google.com/apis/design/design_patterns#partial_response">partial update</a>.</p>
<p>You can utilize reflect API in v2 to deal with the <code>FieldMask</code>:</p>
<pre class="language-go"><code class="language-go code-highlight"><span class="code-line"><span class="token comment">//check field mask existence</span>
</span><span class="code-line"><span class="token keyword">if</span> request<span class="token punctuation">.</span>FieldMask <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">{</span>
</span><span class="code-line">	request<span class="token punctuation">.</span>FieldMask<span class="token punctuation">.</span><span class="token function">Normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">	<span class="token comment">//check if the field mask is valid</span>
</span><span class="code-line">	<span class="token keyword">if</span> ok<span class="token operator">:=</span>request<span class="token punctuation">.</span>FieldMaks<span class="token punctuation">.</span><span class="token function">IsValid</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok<span class="token punctuation">{</span>
</span><span class="code-line">		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">"invalid field mask"</span><span class="token punctuation">)</span>
</span><span class="code-line">	<span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">paths<span class="token operator">:=</span>request<span class="token punctuation">.</span>FieldMask<span class="token punctuation">.</span><span class="token function">GetPaths</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">//the rest is on your own, you can do whatever you what with paths</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">//for example, you can do partial update by your own without reflection since fv.(type) is realy annoying</span>
</span><span class="code-line"><span class="token comment">//notice the protocol buffer `[list](https://pkg.go.dev/google.golang.org/protobuf/reflect/protoreflect#List)` and `[map](https://pkg.go.dev/google.golang.org/protobuf/reflect/protoreflect#List)` type is not same as the go `array` or `map` type.</span>
</span><span class="code-line">rft <span class="token operator">:=</span> request<span class="token punctuation">.</span><span class="token function">ProtoReflect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">rft<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>fd protoreflect<span class="token punctuation">.</span>FieldDescriptor<span class="token punctuation">,</span> fv protoreflect<span class="token punctuation">.</span>Value<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
</span><span class="code-line">	<span class="token comment">//compare fd.JSONName() to the maskPaths value</span>
</span><span class="code-line">	<span class="token comment">//get corresponse field value with fv.(type)</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<h2 id="stream-with-broadcast"><a aria-hidden="true" tabindex="-1" href="#stream-with-broadcast"><span class="icon icon-link"></span></a>Stream with Broadcast</h2>
<p>The most exciting part about gRPC of course is its streaming ability. Though it's no easy feat to implement that for beginners of concurrency (like me). I hope I can ease your pain when implementing the gRPC streaming with broadcasting.</p>
<p>The basics are:</p>
<ul>
<li>Each handler runs in its own goroutine (each connection will have its own
goroutine)</li>
</ul>
<p>As documented in
<a href="https://github.com/grpc/grpc-go/blob/master/Documentation/joncurrency.md#servers">Concurrency</a>:</p>
<blockquote>
<p>Each RPC handler attached to a registered server will be invoked in its own
goroutine. For example,
<a href="https://github.com/grpc/grpc-go/blob/master/examples/helloworld/greeter_server/main.go#L41">SayHello</a>
will be invoked in its own goroutine. The same is true for service handlers
for streaming RPCs, as seen in the route guide example
<a href="https://github.com/grpc/grpc-go/blob/master/examples/route_guide/server/server.go#L126">here</a>.
Similar to clients, multiple services can be registered to the same server.</p>
</blockquote>
<ul>
<li><code>chan</code> is not built for broadcast, it's one-to-one communication</li>
</ul>
<p>You will end up with something like <code>map[string]chan</code>, the <code>string</code> is an
identifier to identify the goroutin (client connection), like a <code>sessionID</code>, or
<code>tracingID</code>, or a random string, or <code>userID</code>.</p>
<p>Pay attention to the last case. Only when you can be sure the user can only log in to one instance, that is each user can only have a single active connection, or the above <code>map</code> becomes to <code>map[userID]map[connectionID]chan</code>. The <code>chan</code> is created in the <code>controller</code> indicating the exact goroutine (connection) which will receive messages from, and the <code>controller</code> will pass the received message to the client.</p>
<p>Here is an oversimplified code:</p>
<pre class="language-go"><code class="language-go code-highlight"><span class="code-line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>server<span class="token punctuation">)</span> <span class="token function">Subscribe</span><span class="token punctuation">(</span>req <span class="token operator">*</span>pb<span class="token punctuation">.</span>SubscribeRequest<span class="token punctuation">,</span> srv pb<span class="token punctuation">.</span>SubscribeServer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
</span><span class="code-line">	<span class="token comment">//get trace id or generated a random string or whatever you want to indicate this goroutine</span>
</span><span class="code-line">	ID<span class="token operator">:=</span><span class="token string">"randomString"</span>
</span><span class="code-line">	<span class="token comment">//create a chan to receive response message</span>
</span><span class="code-line">	conn <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>pb<span class="token punctuation">.</span>SubscribeResponse<span class="token punctuation">)</span>
</span><span class="code-line">	<span class="token keyword">for</span> <span class="token punctuation">{</span>
</span><span class="code-line">		<span class="token comment">//receive message</span>
</span><span class="code-line">		response<span class="token operator">:=</span><span class="token operator">&lt;-</span>conn
</span><span class="code-line">		<span class="token comment">//send to client</span>
</span><span class="code-line">		srv<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
</span><span class="code-line">	<span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<p>Below are some approaches I saw or can think of:</p>
<h3 id="sharing-srv"><a aria-hidden="true" tabindex="-1" href="#sharing-srv"><span class="icon icon-link"></span></a>Sharing <code>srv</code></h3>
<p>This will avoid this <code>map</code> structure or maybe all the <code>channel</code> things.</p>
<pre class="language-go"><code class="language-go code-highlight"><span class="code-line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>server<span class="token punctuation">)</span> <span class="token function">TestHandler</span><span class="token punctuation">(</span>req <span class="token operator">*</span>pb<span class="token punctuation">.</span>TestRequest<span class="token punctuation">,</span> srv pb<span class="token punctuation">.</span>TestServer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
</span><span class="code-line">	<span class="token operator">...</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<p>For a server streaming handler above, you can share the <code>srv</code> between
goroutines. The rest is up to you, you can put the <code>srv</code> in a <code>map</code> or <code>slice</code>
based on what you want. Just be careful as documented in
<a href="https://github.com/grpc/grpc-go/blob/master/Documentation/concurrency.md#streams">Streams</a>:</p>
<blockquote>
<p>When using streams, one must take care to avoid calling either <code>SendMsg</code> or
<code>RecvMsg</code> multiple times against the same
<a href="https://godoc.org/google.golang.org/grpc#Stream">Stream</a> from different
goroutines. In other words, it's safe to have a goroutine calling <code>SendMsg</code>
and another goroutine calling <code>RecvMsg</code> on the same stream at the same time.
But it is not safe to call <code>SendMsg</code> on the same stream in different
goroutines, or to call <code>RecvMsg</code> on the same stream in different goroutines.</p>
</blockquote>
<p>And you certainly need <code>sync.Mutex</code>, I will talk about it later.</p>
<h3 id="sharing-map"><a aria-hidden="true" tabindex="-1" href="#sharing-map"><span class="icon icon-link"></span></a>Sharing <code>map</code></h3>
<p>With the <code>map</code> structure previously mentioned, at some point, you always want to
modify the <code>map</code> structure in another goroutine. For example, you want to access
the <code>map</code> and send a message to the <code>chan</code> in one goroutine, and you want to add
new connections or remove connections from the <code>map</code> in another goroutine, then it
comes to the <code>sync.Mutex</code>, so beware of deadlocks.</p>
<pre class="language-go"><code class="language-go code-highlight"><span class="code-line">	mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">	<span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">	mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></code></pre>
<p>If <code>mu</code> is a <code>sync.Mutex</code> lock, always <code>Lock()</code> and <code>Unlock()</code> in the outer
function, do not <code>Lock()</code> and <code>Unlock</code> in <code>doSomething()</code>, as your code become
complicated, you will not notice when you <code>Lock()</code> twice.</p>
<p>This approach is also sharing memory, and it is prone to deadlocks.</p>
<h3 id="an-intermediate-channel-preferred"><a aria-hidden="true" tabindex="-1" href="#an-intermediate-channel-preferred"><span class="icon icon-link"></span></a>An intermediate Channel (Preferred)</h3>
<p>As said in <a href="https://blog.golang.org/codelab-share">Share Memory By Communicating</a></p>
<blockquote>
<p>Do not communicate by sharing memory; instead, share memory by communicating.</p>
</blockquote>
<p>We can have an intermediate goroutine that has the ownership of the <code>map</code> structure, by ownership I mean only this goroutine can modify the <code>map</code> structure. Messages will be send to an intermediate channel <code>Broadcast</code>, and the <code>Broadcast</code> will modify the <code>map</code> structure, or send messages to <code>channel</code> according to the identifier. The <code>Broadcast</code> has the ownership of the <code>map</code> structure, and the data flows in a single direction.</p>
<p>Some code you can work with:</p>
<pre class="language-go"><code class="language-go code-highlight"><span class="code-line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>server<span class="token punctuation">)</span> <span class="token function">Subscribe</span><span class="token punctuation">(</span>req <span class="token operator">*</span>pb<span class="token punctuation">.</span>SubscribeRequest<span class="token punctuation">,</span> srv pb<span class="token punctuation">.</span>SubscribeServer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
</span><span class="code-line">	<span class="token comment">//get trace id or generated a random string or whatever you want to indicate this goroutine</span>
</span><span class="code-line">	ID<span class="token operator">:=</span><span class="token string">"randomString"</span>
</span><span class="code-line">	<span class="token comment">//create a chan to receive response message</span>
</span><span class="code-line">	conn <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>pb<span class="token punctuation">.</span>SubscribeResponse<span class="token punctuation">)</span>
</span><span class="code-line">	<span class="token comment">//an intermediate channel which incharge of the `map`</span>
</span><span class="code-line">	s<span class="token punctuation">.</span>broadcast <span class="token operator">&lt;-</span> <span class="token operator">&amp;</span>broadcastPayload <span class="token punctuation">{</span>
</span><span class="code-line">		<span class="token comment">//an unique identifier</span>
</span><span class="code-line">		ID<span class="token punctuation">:</span> ID
</span><span class="code-line">		<span class="token comment">//the chan corresponse to the ID</span>
</span><span class="code-line">		Conn<span class="token punctuation">:</span> conn
</span><span class="code-line">		<span class="token comment">//event to indicate add, remove or send message to broadcast channel</span>
</span><span class="code-line">		Event<span class="token punctuation">:</span> EventEnum<span class="token punctuation">.</span>AddConnection
</span><span class="code-line">	<span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">	<span class="token keyword">for</span> <span class="token punctuation">{</span>
</span><span class="code-line">		<span class="token keyword">select</span> <span class="token punctuation">{</span>
</span><span class="code-line">			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>srv<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">				s<span class="token punctuation">.</span>broadcast <span class="token operator">&lt;-</span> <span class="token operator">&amp;</span>entity<span class="token punctuation">.</span>BroadcastPayload<span class="token punctuation">{</span>
</span><span class="code-line">					 ID<span class="token punctuation">:</span> ID<span class="token punctuation">,</span>
</span><span class="code-line">					 Event<span class="token punctuation">:</span> EventEnum<span class="token punctuation">.</span>RemoveConnection
</span><span class="code-line">				<span class="token punctuation">}</span>
</span><span class="code-line">				<span class="token keyword">return</span> <span class="token boolean">nil</span>
</span><span class="code-line">			<span class="token keyword">case</span> response <span class="token operator">:=</span> <span class="token operator">&lt;-</span>conn<span class="token punctuation">:</span>
</span><span class="code-line">				<span class="token keyword">if</span> status<span class="token punctuation">,</span> ok <span class="token operator">:=</span> status<span class="token punctuation">.</span><span class="token function">FromError</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
</span><span class="code-line">					<span class="token keyword">switch</span> status<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">					<span class="token keyword">case</span> codes<span class="token punctuation">.</span>OK<span class="token punctuation">:</span>
</span><span class="code-line">						<span class="token comment">//noop</span>
</span><span class="code-line">					<span class="token keyword">case</span> codes<span class="token punctuation">.</span>Unavailable<span class="token punctuation">,</span> codes<span class="token punctuation">.</span>Canceled<span class="token punctuation">,</span> codes<span class="token punctuation">.</span>DeadlineExceeded<span class="token punctuation">:</span>
</span><span class="code-line">						<span class="token keyword">return</span> <span class="token boolean">nil</span>
</span><span class="code-line">					<span class="token keyword">default</span><span class="token punctuation">:</span>
</span><span class="code-line">						<span class="token keyword">return</span> <span class="token boolean">nil</span>
</span><span class="code-line">			 <span class="token punctuation">}</span>
</span><span class="code-line">		 <span class="token punctuation">}</span><span class="token punctuation">}</span>
</span><span class="code-line">	<span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<pre class="language-go"><code class="language-go code-highlight"><span class="code-line"><span class="token comment">//this goroutine has the ownership of the map[string]chan *pb.SubscribeResponse</span>
</span><span class="code-line"><span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
</span><span class="code-line">	<span class="token keyword">for</span> v<span class="token operator">:=</span><span class="token keyword">range</span> s<span class="token punctuation">.</span>broadcast <span class="token punctuation">{</span>
</span><span class="code-line">		<span class="token comment">//do something based on the event</span>
</span><span class="code-line">		<span class="token keyword">switch</span> v<span class="token punctuation">.</span>Event <span class="token punctuation">{</span>
</span><span class="code-line">			<span class="token comment">//add ID and its corresponding Conn to the map</span>
</span><span class="code-line">			<span class="token keyword">case</span> EventEnum<span class="token punctuation">.</span>AddConnection<span class="token punctuation">:</span>
</span><span class="code-line">				<span class="token operator">...</span>
</span><span class="code-line">			<span class="token comment">//delete ID and its corresponding Conn from the map</span>
</span><span class="code-line">			<span class="token keyword">case</span> EventEnum<span class="token punctuation">.</span>RemoveConnection<span class="token punctuation">:</span>
</span><span class="code-line">				<span class="token operator">...</span>
</span><span class="code-line">			<span class="token comment">//receive message from bussiness logic, send the message to suiteable Conn in the map as you like</span>
</span><span class="code-line">			<span class="token keyword">case</span> EventEnum<span class="token punctuation">.</span>ReceiveResponse<span class="token punctuation">:</span>
</span><span class="code-line">				<span class="token operator">...</span>
</span><span class="code-line">		<span class="token punctuation">}</span>
</span><span class="code-line">	<span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<h3 id="maybe-a-counter"><a aria-hidden="true" tabindex="-1" href="#maybe-a-counter"><span class="icon icon-link"></span></a>Maybe a counter?</h3>
<p>Without a <code>map</code> to identify the single <code>chan</code> used by the single connection, another approach I saw online is to use a counter. The counter will record the number of connections by a single <code>user</code> or a custom <code>subject</code>, single <code>user</code> or <code>subject</code> will share a <code>chan</code>(comparing to the above, each connection uses a single <code>chan</code>), you can use the <code>sync.Mutex</code> or <code>sync/atomic</code> to modify the counter when the new connection comes in or drop out. The counter will decide how many times you want to send to the <code>chan</code>.</p>
<h3 id="synccond"><a aria-hidden="true" tabindex="-1" href="#synccond"><span class="icon icon-link"></span></a>sync.Cond</h3>
<p>If the use case is really simple, I think <code>sync.Cond</code> is also a valid approach, but I never tried this.</p>
<p>I prefer the 3rd approach, it avoids memory sharing and the code is cleaner.</p>
<h3 id="going-distributed"><a aria-hidden="true" tabindex="-1" href="#going-distributed"><span class="icon icon-link"></span></a>Going distributed</h3>
<p>If you want to use a messaging system, like <code>kafka</code> or <code>NATS</code>, the idea is the same, use an intermediate <code>channel</code> to manage your connections.</p>
<h2 id="continue"><a aria-hidden="true" tabindex="-1" href="#continue"><span class="icon icon-link"></span></a>Continue</h2>
<p>A lot of topics haven't been included, like gRPC-web, testing, gRPC-gateway, health check, profiling and so many things, I will continue with a 2nd post in the future.
Hope you like this one, if you have questions or suggestions, or how you solve the above problems, just submit an issue <a href="https://github.com/washanhanzi/washanhanzi.github.io">here</a>, all are welcomed.</p>
<h2 id="refs"><a aria-hidden="true" tabindex="-1" href="#refs"><span class="icon icon-link"></span></a>Refs</h2>
<ul>
<li><a href="https://blog.gopheracademy.com/advent-2017/go-grpc-beyond-basics/">gRPC Go: Beyond the basics</a></li>
<li><a href="https://www.cnblogs.com/FireworksEasyCool/p/12750339.html">Go gRPC è¿é¶-go-grpc-middleware ä½¿ç¨</a></li>
<li><a href="https://www.youtube.com/watch?v=Z_yD7YPL2oE&amp;list=FL_F0hJOcLaFNDptQDkcoSQA&amp;index=1">Best Practices for (Go) gRPC Services</a></li>
<li><a href="https://www.usenix.org/conference/srecon19asia/presentation/sheerin">Yes, No, Maybe? Error Handling with gRPC
Examples</a></li>
<li><a href="https://blog.stackpulse.com/tech-blog/grpc-in-practice-directory-structure-linting-and-more/?mode=dark">gRPC in Practice</a></li>
<li><a href="https://djangogrpcframework.readthedocs.io/en/latest/patterns/partial_update.html">Handling Partial Update</a></li>
</ul><!--/qv--><!--/qv--></article></div><!--/qv--><!--/qv--></main></div><!--/qv--><script>(async(t,n)=>{var s;if(!window._qcs&&history.scrollRestoration==="manual"){window._qcs=!0;const c=(s=history.state)==null?void 0:s._qCityScroll;c&&window.scrollTo(c.x,c.y);const o=document.currentScript;(await import(t))[n](o)}})('/build/q-61e731e2.js','s_DyVc0YBIqQU');</script><!--/qv--><!--/qv--><!--qv q:key=35_2--><script q:key="1Z_0">((s,a,i,r)=>{i=(e,t)=>{t=document.querySelector("[q\\:base]"),t&&a.active&&a.active.postMessage({type:"qprefetch",base:t.getAttribute("q:base"),...e})},document.addEventListener("qprefetch",e=>{const t=e.detail;a?i(t):t.bundles&&s.push(...t.bundles)}),navigator.serviceWorker.register("/service-worker.js").then(e=>{r=()=>{a=e,i({bundles:s})},e.installing?e.installing.addEventListener("statechange",t=>{t.target.state=="activated"&&r()}):e.active&&r()}).catch(e=>console.error(e))})([])</script><!--/qv--></body><!--/qv--><!--/qv--><!--/qv--><script type="qwik/json">{"refs":{},"ctx":{},"objs":[],"subs":[]}</script></html>